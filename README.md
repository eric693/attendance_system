# 企業出勤管理系統 - 模組化版本

## 🎯 系統特色

✅ **網路限制**：設定為 `147.92.150.0/24` 網路範圍才能打卡  
✅ **完整功能**：保留所有原有功能（上班打卡、下班打卡、今日狀態、查看記錄）  
✅ **模組化架構**：將系統拆分為多個 Python 檔案，便於維護  
✅ **權限管理**：管理員/員工兩層權限  
✅ **自助註冊**：員工可自行註冊帳號  

## 📁 檔案結構

```
attendance_system/
├── main.py                 # 主程式啟動檔
├── models.py               # 資料庫模型和初始化
├── network_security.py     # 網路安全管理模組
├── attendance.py           # 出勤管理模組（核心功能）
├── message_processor.py    # LINE Bot 訊息處理
├── admin_routes.py         # 管理後台路由
├── templates.py            # HTML 模板
└── README.md              # 系統說明文件
```

## 🚀 快速開始

### 1. 安裝依賴套件

```bash
pip install flask line-bot-sdk pytz
pip install Pillow  # 可選，用於 Rich Menu 圖片生成
```

### 2. 設定 LINE Bot

在 `main.py` 中修改您的 LINE Bot 設定：

```python
ACCESS_TOKEN = 'your_line_bot_access_token'
WEBHOOK_SECRET = 'your_webhook_secret'
```

### 3. 啟動系統

```bash
python main.py
```

### 4. 系統網址

- **首頁**：http://localhost:5008
- **管理後台**：http://localhost:5008/admin
- **預設帳號**：admin / admin123

## 🌐 網路設定說明

### 允許的網路範圍

系統預設允許 `147.92.150.0/24` 網路範圍內的設備打卡：

- **網路範圍**：172.20.10.0 到 172.20.10.15
- **可用IP**：共16個IP地址
- **子網路遮罩**：255.255.255.240

### 修改網路設定

1. **透過管理後台**：
   - 登入管理後台
   - 進入「網路安全設定」
   - 修改「允許的網路範圍」

2. **修改預設值**：
   在 `models.py` 中找到：
   ```python
   ('allowed_networks', '147.92.150.0/24', '允許打卡的網路範圍(用逗號分隔)')
   ```

### 支援的網路格式

- **單一IP**：`172.20.10.5`
- **網路段**：`147.92.150.0/24`
- **多個網路**：`147.92.150.0/24,192.168.1.0/24`

## 📱 LINE Bot 功能

### 👤 員工功能

| 指令 | 功能 | 說明 |
|------|------|------|
| `上班打卡` / `上班` | 上班打卡 | 記錄上班時間，檢查網路位置 |
| `下班打卡` / `下班` | 下班打卡 | 記錄下班時間，計算工時 |
| `今日狀態` / `狀態` | 查看今日狀態 | 顯示工作狀態和打卡記錄 |
| `查看記錄` / `記錄` | 查看出勤記錄 | 顯示最近10筆打卡記錄 |
| `個人統計` / `統計` | 個人統計報表 | 本月出勤天數和工時統計 |
| `網路檢查` | 檢查網路狀態 | 確認當前IP是否可打卡 |
| `註冊員工` | 自助註冊 | 新用戶自行註冊流程 |

### 👨‍💼 管理員功能

| 指令 | 功能 | 說明 |
|------|------|------|
| `員工管理` | 員工管理 | 查看員工列表、新增員工 |
| `出勤統計` | 出勤統計 | 查看出勤報表和統計 |
| `網路設定` | 網路管理 | 管理允許的網路範圍 |

## 🔧 模組說明

### 1. main.py - 主程式
- Flask 應用初始化
- LINE Bot webhook 處理
- 系統啟動和設定

### 2. models.py - 資料庫模型
- 資料庫結構定義
- 員工管理類
- 公司設定管理類
- **重點**：包含網路設定預設值

### 3. network_security.py - 網路安全
- IP 地址驗證
- 網路範圍檢查
- 打卡權限驗證

### 4. attendance.py - 出勤管理 ⭐
- **上班打卡**：`clock_in()`
- **下班打卡**：`clock_out()`
- **今日狀態**：`get_today_status()`
- **查看記錄**：`get_attendance_records()`
- **個人統計**：`get_personal_stats()`
- **工時計算**：`calculate_daily_hours()`

### 5. message_processor.py - 訊息處理
- LINE Bot 指令處理
- 自助註冊流程
- 回應訊息生成

### 6. admin_routes.py - 管理後台
- 管理員登入
- API 路由處理
- 權限控制

### 7. templates.py - HTML 模板
- 首頁模板
- 管理後台模板

## 💡 使用流程

### 新員工註冊

1. **加入 LINE Bot**
2. **選擇註冊方式**：
   - 方式一：輸入 `註冊員工` 自助註冊
   - 方式二：請管理員在後台新增
3. **完成註冊後開始使用**

### 日常打卡

1. **確認網路**：使用 `網路檢查` 確認可打卡
2. **上班打卡**：輸入 `上班打卡`
3. **查看狀態**：輸入 `今日狀態` 查看工作狀態
4. **下班打卡**：輸入 `下班打卡`

### 管理員操作

1. **登入後台**：http://localhost:5008/admin
2. **網路設定**：管理允許的網路範圍
3. **員工管理**：查看員工列表、新增員工
4. **查看統計**：監控出勤情況

## 🔒 安全特色

- **網路位置驗證**：只允許特定網路範圍打卡
- **IP 記錄追蹤**：所有打卡都記錄 IP 地址
- **權限分離**：管理員和員工功能分離
- **違規監控**：記錄網路違規嘗試

## 🆘 故障排除

### 常見問題

1. **無法打卡**
   - 檢查網路連接是否在 147.92.150.0/24 範圍內
   - 使用 `網路檢查` 指令確認狀態

2. **管理後台無法登入**
   - 預設帳號：admin / admin123
   - 確認系統正常啟動

3. **LINE Bot 無回應**
   - 檢查 ACCESS_TOKEN 和 WEBHOOK_SECRET
   - 確認 webhook URL 設定正確

## 📞 技術支援

如有任何問題，請檢查：
1. 系統啟動日誌
2. 網路設定是否正確
3. LINE Bot 設定是否完整

---

🎉 **恭喜！您的企業出勤管理系統已就緒！**

## 🔄 系統更新說明

### v2.0 模組化版本
- ✅ 將系統拆分為 8 個獨立模組
- ✅ 網路設定改為 147.92.150.0/24
- ✅ 保留所有核心功能
- ✅ 優化程式碼結構和可維護性
- ✅ 完整的說明文件和使用指南

### 核心功能保證
所有原有功能完全保留：
- ✅ 上班打卡 / 下班打卡
- ✅ 今日狀態 / 查看記錄
- ✅ 個人統計 / 網路檢查
- ✅ 自助註冊 / 權限管理